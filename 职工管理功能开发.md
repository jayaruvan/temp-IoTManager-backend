## 职工管理开发

职工管理功能基于IoTManager原有功能开发，RFID设备记录职工打卡情况，将数据传给MongoDB

**数据说明：**

```Json
{
    "_id": ObjectId("5eb4ef2d27cc6d15d42e6f5a"),
    "DeviceId": "RFID-01",			//RFID设备Id
    "DeviceName": "门禁设备",		//RFID设备名称
    "MonitorName": "吴先生",		//职工姓名
    "MonitorId": "2014170117",	  //职工工号
    "Unit": "bool",
    "MonitorType": "bool",
    "Value": 1,  				//1表示进入，0表示离开
    "Timestamp": ISODate("2020-05-08T05:33:33.000Z"),
    "IsScam": "true",
    "GatewayId": "TG-001",		//RFID所在的网关Id
    "DeviceType": "78",			//设备类型，MYSQL中config表中78是指门禁设备，后面指定TypeId
    "Mark": "t",
    "IsCheck": "false"
}
```

```json
{
    "_id" : ObjectId("5ebcf6f6444b1bb6eef48adc"),
    "MonitorId" : "E200001B6416014801707B0E",
    "DeviceId" : "001625120DBE#1",
    "Timestamp" : ISODate("2020-05-14T07:44:53.984Z"),
    "GateWayID" : "001625120DBE",
    "IsScam" : "false",
    "IsCheck" : "false",
    "DeviceType" : "78",
    "DeviceName" : "门禁设备",
    "MonitorName" : "吴先生",
    "MonitorType" : "false",
    "Mark" : "t",
    "Unit" : "false",
    "value" : 1
}
```



### 功能描述与分析

​		职工权限管理、职工踪迹记录、车间人数实时统计、考勤记录、访客管理

​		建立RFID标签与人员之间的实时关系后，实质功能就转化成：标签进出天线所在地的权限管理、标签在每个天线的应答记录统计。职工和访客使用流动标签（考虑职工入职离职，访客登记注销），插入MongoDB的数据只需以下字段（免去查找MYSQL的环节）

```json
{
    "_id": ObjectId("5ebd0fe4b0182dba0e4b7003"),
    "MonitorId": "E200001B6416014901507B2E",
    "DeviceId": "001625120DBE#2",
    "Timestamp": ISODate("2020-05-14T09:31:16.928Z"),
    "GatewayId": "001625120DBE",
    //"IsScam": "false",
    //"IsCheck": "false",
    "DeviceType": "78",		//设备类型和设备名称约定好，Web端注册设备时提供此处的DeviceId、
    "DeviceName": "门禁设备",//DeviceName、DeviceType、GatewayId
    //"MonitorName": "吴先生",
    //"MonitorType": "false",
    //"Mark": "t",
    //"Unit": "false",
    "value": NumberInt("0")
}
```

​		【职工权限验证】：刷卡时，获取标签Id，查MSQL的staffId表，找到对应的staffId，获取相应的权限列表比对。还是需要刷卡检测一下就查一下MYSQL？（待解决）

​		【权限管理】：①按部门批量添加，②单独添加，③权限删除时只需更新绑定转态status，以便在权限变更后还能查到数据。

​		【职工踪迹查询】：输入职工staffId，获取标签Id，以及持有此标签的时间段，按时间段和标签Id查MongoDB数据，获取到访的RFID天线以及时间。

​		【车间人数实时统计】：通过deviceId获取MongoDB中当天最新的设备数据，按标签Id（MonitorId）分类统计进出次数及时间，获取当天持这些标签的人员信息（考虑不同时间段存在不同的人员持有相同标签的情况，在staff表和customer表分别添加status字段表示staffid卡和持卡人关系的状态），输出车间实时在岗人数、离开人数、访客人数以及人员信息。

​		【考勤记录】：①统计车间的考勤情况：从staffauth获取每个设备中注册的所有staffId、从rfidtag表中获取对应的标签Id顺便使用type字段判断是否为公司员工，按照标签id 和deviceId查MongoDB数据，按天查如果没有数据说明缺勤。②统计员工个人的考勤情况：通过staffId获取所有持有过的标签（考虑更换门禁卡）以及时间段，从MongoDB，按时间段和标签Id查数据，统计刷卡记录即考勤记录。③按部门统计：...④历史考勤：新建考勤表保存迭代数据。

​		【访客管理】：访客进入前需登记，离开时需注销。①登记时：取一个标签，标签Id需存入rfidtag表，录入访客信息staffid使用rfidtag表中的staffId（status=1，lastArea和lastTime字段保留），根据访客需求，给标签授予访问权限录入staffauth表中。②离开时：获取该标签访问最后区域存入lastArea字段，status置为0，更新离开时间。

​		【职工入职/离职】：等同于访客管理操作

​		【人员信息的删除操作】：职工离职或访客离去后MYSQL数据库会保留人员信息，但状态显示离职/注销状态，方便查看离职人员/访客历史到访地，可选择性删除人员信息（提示会删除MongoDB中人员刷卡记录）

##### 工作流程

【配置阶段】

1. 录入部门信息表、职称信息表、设备表（每一个RFID天线代表一个设备）
2. 录入员工信息表（员工登记）
3. 每位员工配发一个无源标签（卡），无源标签存储的信息只有标签Id，如E200001B6416014901507B2E。使用前将标签Id与员工工号一一对应录入到MYSQL的rfidtag表，

【使用阶段】

1. 人员进出刷卡：RFID读卡器读取标签的Id，（权限验证...验证失败会发数据到MongoDB吗？如果发，如何标志错误？）将标签Id、deviceId等数据发送至MongoDB
2. 访客登记/注销刷卡
3. 员工入职/离职刷卡

### 接口设计

1. 职工

   【添加】：包含职工工号、姓名、部门、职称、性别、年龄、手机号、邮箱、备注

   【删除】：单个删除、批量删除

   【查找】：员工列表、员工个人信息、按部门查看、分页显示、搜索

   【修改】：修改内容：部门、职称修改、手机号、邮箱、备注，照片上传

2. 部门

   【添加】：部门名称、管理员（工号+姓名）、备注

   【删除】：不用删除部门员工，处理时将该部门的员工所属部门置为null

   【查找】：部门列表

   【修改】：管理员，备注、名称

3. 访客

   【添加】：卡片编号（staffId）、姓名、性别、手机号、所属机构/单位、事由、状态、最后访问区域、离开时间、登记时间、备注

   【修改】：修改内容：staffId、姓名、性别、手机号、所属机构、事由、备注

   【查找】：按登记时间、staffId、离开时间、姓名

   【删除】：删除提醒是否删除刷卡记录

   【注销】：最后访问区域、离开时间、状态改变

4. 职工权限配置

   【按设备添加授权职工】：选定一个门禁设备，选择有权进入该设备所在地的职工

   【按职工添加门禁权限】：选定一个职工，选择该职工有进出权限的门禁设备

5. 职工打卡统计

   - 当前车间A人员总数，固定人员数量、外来人员数量、人员清单、今日打卡人数
   - 车间A历史考勤人数
   - 车间A最新打卡职工信息展示
   - 按部门统计今日打卡人数、总人数、历史打卡人数、总人数
   - 查找职工s在一段时间内的足迹（当前所在车间，在每个车间的进出次数以及时间）

#### 数据库设计：

1. device表：沿用IoTManager项目的device表，deviceId使用RFID读卡器Mac+天线编号，如：001625120DBE#1，deviceType使用特定的设备类型

   ```json
   //设备表字段说明
   --------------------------------
   Field		|Type	|Description
   id
   hardwareDeviceID	//001625120DBE#1
   deviceName			//表示车间名称或者办公室编号
   city
   factory
   workshop
   deviceState
   imageUrl
   gatewayId
   mac
   deviceType
   remark
   lastConnectionTime
   createTime
   updateTime
   isOnline
   ```

   

2. staff表：

   ```json
   //职工表字段说明
   --------------------------------
   Field		|Type	|Description
   id			string	//自增Id
   staffId		string	//职工工号
   staffName	string	//姓名	
   staffRole	int		//职称	
   department	int		//部门
   gender		string	//性别	
   age			int		//年龄		
   phoneNumber	string	//手机号		
   email		string	//邮箱		
   remark		string	//备注		
   ceateTime	DateTime		
   updateTime	DateTime		
   base64Image	mediumtext		
   status		byte	//是否离职
   lastTime			//离职注销日期
   ```

3. department表：

   ```json
   //部门表，字段说明
   -----------------------------------
   Field		Type		Description
   id
   departmentName			//部门名称
   admin					//主管工号
   remark
   createTime
   updateTime
   ```

   

4. rfidtag表：

   ```json
   //RFID标签Id与staffId对应关系，字段说明
   -----------------------------------
   Field		Type		Description
   id
   staffId					//职工工号（卡号）
   tagid					//标签Id
   type					//标注职工或访客
   status					//标志staffId与此标签绑定状态
   createTime				//绑定时间
   updateTime
   lastTime				//记录解绑时间
   ```

5. staffauth表：

   ```json
   //员工权限表，字段说明
   -----------------------------------
   Field		Type		Description
   id
   staffId					//工号（卡号）
   device					//device.id
   timestamp
   ```

   

6. customer表：

   ```json
   //访客信息表，字段说明
   -----------------------------------
   Field		Type		Description
   id
   staffId					//卡号
   name					//姓名
   gender					//性别
   phoneNumber
   affiliation				//所属机构、单位
   cause					//事由
   status					//是否注销离开
   lastArea				//最后到访区域
   remark					//备注
   createTime				//登记时间
   lastTime				//离开时间
   updateTime
   ```

   

7. staffrole表：

   ```json
   //职称表，字段说明
   -----------------------------------
   Field		Type		Description
   id						
   staffRole				//职称
   createTime
   updateTime
   ```

   



















































