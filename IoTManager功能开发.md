## 职工管理开发

职工管理功能基于IoTManager原有功能开发，RFID设备记录职工打卡情况，将数据传给MongoDB

**数据说明：**

```Json
{
    "_id": ObjectId("5eb4ef2d27cc6d15d42e6f5a"),
    "DeviceId": "RFID-01",			//RFID设备Id
    "DeviceName": "门禁设备",		//RFID设备名称
    "MonitorName": "吴先生",		//职工姓名
    "MonitorId": "2014170117",	  //职工工号
    "Unit": "bool",
    "MonitorType": "bool",
    "Value": 1,  				//1表示进入，0表示离开
    "Timestamp": ISODate("2020-05-08T05:33:33.000Z"),
    "IsScam": "true",
    "GatewayId": "TG-001",		//RFID所在的网关Id
    "DeviceType": "78",			//设备类型，MYSQL中config表中78是指门禁设备
    "Mark": "t",
    "IsCheck": "false"
}
```

#### 问题说明

职工工号类似于设备属性，设备属性只能被一个设备拥有，但是工号可以注册到多个门禁设备中，且属性（field）与职工（staff）具有不同的字段，故另外设计staff表，门禁设备与职工之间是多对多关系，原始的设备与设备属性之间是多对一的关系，因此建立staffauth表存放staff和device的关系。AlarmJob.cs中有一个功能是自动添加设备属性，该功能会将MongoDB中设备具有的属性更新到MYSQL中，也就是会更新field表（后期改进，按设备类型排查）。职工统计页面所有数据均来自门禁设备，注册设备时有必要将设备类型规范一下。

### 功能介绍

1. 职工

   【添加】：包含职工工号、姓名、部门、职称、性别、年龄、手机号、邮箱、备注

   【删除】：单个删除、批量删除

   【查找】：员工列表、员工个人信息、按部门查看、分页显示、搜索

   【修改】：修改内容：部门、职称修改、手机号、邮箱、备注，照片上传

2. 部门

   【添加】：部门名称、管理员（工号+姓名）、备注

   【删除】：不用删除部门员工，处理时将该部门的员工所属部门置为null

   【查找】：部门列表

   【修改】：管理员，备注、名称

3. 职工权限配置

   【按设备添加授权职工】：选定一个门禁设备，选择有权进入该设备所在地的职工

   【按职工添加门禁权限】：选定一个职工，选择该职工有进出权限的门禁设备

   问：硬件上检测到职工无权进入车间时会不会上报数据到MongoDB？

4. 职工打卡统计

   - 当前车间A人员总数，固定人员数量、外来人员数量、人员清单、今日打卡人数
   - 车间A历史考勤人数
   - 车间A最新打卡职工信息展示
   - 按部门统计今日打卡人数、总人数、历史打卡人数、总人数
   - 查找职工s在一段时间内的足迹（当前所在车间，在每个车间的进出次数以及时间）

#### 需求问题：

1. 外来人员所佩戴的无源标签事先配置权限，作为备用标签存放的信息是什么，外来人员的信息什么时候存入备用标签？
2. 行政职工，车间工人和部门之间的关系？



## IoTManager平台Bug

### 页面逻辑

#### 仪表板

1. 仪表板的自动刷新：（1）刷新时间太快（2）刷新内容不对，目前是整个页面刷新，应该按组件刷新，筛选框的内容不应该刷新



#### 设备管理

##### 网关设备

1. 网关设备列表目前只获取了60条数据，分页最多5页

##### 物理设备

1. 物理设备列表获取速度太慢
2. 最多60条数据，分页功能有上限

##### 设备数据

#### 监控告警

##### 监控配置

###### 设备概况

1. 设备状态中的运行时长计算方式错误
2. 设备照片上传方式：目前是将照片转成base64Image保存到MYSQL，但数据比较长，影响速度

###### 定义告警规则

1. 通知方式：短信、邮件

##### 告警信息

1. 分页信息获取有问题
2. 告警规则删除时无法从MongoDB删除相关的告警信息，（需要在alarmInfo表中数据添加字段标志是来自哪条告警规则）

#### 报表中心



### 代码层面

1. 异常处理：MVC架构，异常处理可以使用全局异常处理，添加中间件，但是目前的代码添加中间件会影响之前的数据返回



### Task

1. 外来人员管理：department表里新增一个部门"访客"，用于标记是外来人员还是职工
2. 访客登记时staff表新增数据，离开时访客注销，删除数据
3. 设备数据属性表新增字段设备属性ID，唯一标识设备类型，MongoDB上传数据时指定设备类型为设备属性ID
4. 【系统配置】->【属性配置】页面（筛选一下设备类型）
5. AlarmJob.cs自动添加属性功能：增加设备类型属性筛选
6. 清理test数据
7. 【告警信息】页面，告警信息数据不全
8. 【设备数据】页面，导出Excel数据不全
9. 告警方式：邮件、短信
10. Solvey新版本部署说明
11. 登录页面名称修改成CloudWeaver AIOT管理平台
12. 职工管理API：最近入场10人，离场的10人



















































